name: Performance Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (dev, test, acc, prod)'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - acc
          - prod
      virtual_users:
        description: 'Number of virtual users'
        required: false
        default: '1'
        type: string
      duration:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '30s'
        type: string

concurrency:
  group: performance-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run k6 tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5

      - name: Install xk6
        run: go install go.k6.io/xk6/cmd/xk6@latest

      - name: Build custom k6 binary with Dynatrace extension
        run: xk6 build --with github.com/Dynatrace/xk6-output-dynatrace -o $(go env GOPATH)/bin/k6

      - name: Prepare k6 flags
        id: prepare-flags
        uses: ./.github/actions/prepare-k6-flags
        with:
          environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
          virtual-users: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.virtual_users || '' }}
          duration: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.duration || '' }}
          dynatrace-url: ${{ secrets.K6_DYNATRACE_URL }}
          dynatrace-api-token: ${{ secrets.K6_DYNATRACE_APITOKEN }}

      - name: Run k6 tests
        id: run-k6-test
        uses: grafana/run-k6-action@v1
        env:
          K6_DYNATRACE_URL: ${{ secrets.K6_DYNATRACE_URL }}
          K6_DYNATRACE_APITOKEN: ${{ secrets.K6_DYNATRACE_APITOKEN }}
          K6_WEB_DASHBOARD: true
          K6_WEB_DASHBOARD_PORT: -1
          K6_WEB_DASHBOARD_PERIOD: 10s
          K6_WEB_DASHBOARD_EXPORT: k6-report.html
        with:
          path: tests/*.spec.ts
          flags: ${{ steps.prepare-flags.outputs.flags }}
          debug: true

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: k6-report.html
          retention-days: 30

      - name: Send Slack notification
        id: send-slack-notification
        if: always()
        uses: ./.github/actions/send-slack-notification
        with:
          test-name: Performance Tests
          environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
          job-status: ${{ job.status }}
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          github-server-url: ${{ github.server_url }}
          github-repository: ${{ github.repository }}
          github-run-id: ${{ github.run_id }}
