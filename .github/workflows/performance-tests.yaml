name: Performance Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (dev, test, acc, prod)'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - acc
          - prod
      virtual_users:
        description: 'Number of virtual users'
        required: false
        default: '1'
        type: string
      duration:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '30s'
        type: string
      tests:
        description: 'Tests to run (comma-separated, e.g., meter-ingestion,health-check). Leave empty to run all tests.'
        required: false
        default: ''
        type: string

jobs:
  test:
    name: ${{ matrix.test-name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: Meter Ingestion Test
            test-file: tests/meter-ingestion.spec.ts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5

      - name: Install xk6
        run: go install go.k6.io/xk6/cmd/xk6@latest

      - name: Build custom k6 binary with Dynatrace extension
        run: xk6 build --with github.com/Dynatrace/xk6-output-dynatrace -o $(go env GOPATH)/bin/k6

      - name: Prepare k6 flags
        id: prepare-flags
        env:
          K6_DYNATRACE_URL: ${{ secrets.K6_DYNATRACE_URL }}
          K6_DYNATRACE_APITOKEN: ${{ secrets.K6_DYNATRACE_APITOKEN }}
        run: |
          ENV="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}"
          VUS="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.virtual_users || '' }}"
          DUR="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.duration || '' }}"
          
          FLAGS="--env ENVIRONMENT=$ENV"
          [ -n "$VUS" ] && FLAGS="$FLAGS --env VIRTUAL_USERS=$VUS"
          [ -n "$DUR" ] && FLAGS="$FLAGS --env DURATION=$DUR"
          
          # Only add Dynatrace output if secrets are configured
          if [ -n "$K6_DYNATRACE_URL" ] && [ -n "$K6_DYNATRACE_APITOKEN" ]; then
            FLAGS="$FLAGS -o output-dynatrace"
            echo "Dynatrace output enabled"
          else
            echo "Dynatrace output disabled (secrets not configured)"
          fi
          
          echo "flags=$FLAGS" >> $GITHUB_OUTPUT
          echo "k6 flags: $FLAGS"

      - name: Prepare report filename
        id: report-filename
        run: |
          REPORT_NAME=$(echo "${{ matrix.test-name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
          REPORT_FILE="reports/k6-report-${REPORT_NAME}.html"
          echo "filename=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "name=$REPORT_NAME" >> $GITHUB_OUTPUT

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run k6 test
        id: run-k6-test
        uses: grafana/run-k6-action@v1
        env:
          K6_DYNATRACE_URL: ${{ secrets.K6_DYNATRACE_URL }}
          K6_DYNATRACE_APITOKEN: ${{ secrets.K6_DYNATRACE_APITOKEN }}
          K6_WEB_DASHBOARD: true
          K6_WEB_DASHBOARD_PORT: -1
          K6_WEB_DASHBOARD_PERIOD: 10s
          K6_WEB_DASHBOARD_EXPORT: ${{ steps.report-filename.outputs.filename }}
        with:
          path: ${{ matrix.test-file }}
          flags: ${{ steps.prepare-flags.outputs.flags }}
          debug: true

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report-${{ steps.report-filename.outputs.name }}
          path: ${{ steps.report-filename.outputs.filename }}
          retention-days: 30

      - name: Send Slack notification
        id: send-slack-notification
        if: always()
        uses: ./.github/actions/send-slack-notification
        with:
          test-name: ${{ matrix.test-name }}
          environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
          job-status: ${{ job.status }}
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          github-server-url: ${{ github.server_url }}
          github-repository: ${{ github.repository }}
          github-run-id: ${{ github.run_id }}