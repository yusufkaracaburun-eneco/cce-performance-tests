name: Performance Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (dev, test, acc, prod)'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - acc
          - prod
      virtual_users:
        description: 'Number of virtual users'
        required: false
        default: '1'
        type: string
      duration:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '30s'
        type: string

jobs:
  test:
    name: ${{ matrix.test-name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - test-name: Meter Ingestion Test
            test-file: tests/meter-ingestion.spec.ts
            needs-custom-binary: false
          - test-name: Health Check Test
            test-file: tests/health-check.spec.ts
            needs-custom-binary: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        if: matrix.needs-custom-binary
        uses: actions/setup-go@v5
        with:
          go-version: 'latest'

      - name: Install xk6
        if: matrix.needs-custom-binary
        run: go install go.k6.io/xk6/cmd/xk6@latest

      - name: Build custom k6 binary with Dynatrace extension
        if: matrix.needs-custom-binary
        run: xk6 build --with github.com/Dynatrace/xk6-output-dynatrace

      - name: Setup k6
        if: ${{ !matrix.needs-custom-binary }}
        uses: grafana/setup-k6-action@v1

      - name: Run test
        if: ${{ !matrix.needs-custom-binary }}
        env:
          ENVIRONMENT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
          VIRTUAL_USERS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.virtual_users || '' }}
          DURATION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.duration || '' }}
        uses: grafana/run-k6-action@v1
        with:
          path: ${{ matrix.test-file }}
          flags: --compatibility-mode experimental_enhanced
          inspect-flags: --compatibility-mode experimental_enhanced

      - name: Run dynatrace test
        if: matrix.needs-custom-binary
        env:
          ENVIRONMENT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
          VIRTUAL_USERS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.virtual_users || '' }}
          DURATION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.duration || '' }}
          K6_DYNATRACE_URL: ${{ secrets.K6_DYNATRACE_URL }}
          K6_DYNATRACE_APITOKEN: ${{ secrets.K6_DYNATRACE_APITOKEN }}
          K6_DYNATRACE_FLUSH_PERIOD: ${{ secrets.K6_DYNATRACE_FLUSH_PERIOD }}
        run: |
          ENV_FLAGS="--env ENVIRONMENT=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}"
          if [ -n "$VIRTUAL_USERS" ]; then
            ENV_FLAGS="$ENV_FLAGS --env VIRTUAL_USERS=$VIRTUAL_USERS"
          fi
          if [ -n "$DURATION" ]; then
            ENV_FLAGS="$ENV_FLAGS --env DURATION=$DURATION"
          fi
          ./k6 run $ENV_FLAGS ${{ matrix.test-file }} ${{ matrix.output-flag }}
        continue-on-error: true

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ Passed"
            COLOR="good"
          else
            STATUS="❌ Failed"
            COLOR="danger"
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "Performance Test Results",
                "fields": [
                  {
                    "title": "Test",
                    "value": "${{ matrix.test-name }}",
                    "short": true
                  },
                  {
                    "title": "Environment",
                    "value": "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "$STATUS",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "ts": $(date +%s)
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            $SLACK_WEBHOOK_URL