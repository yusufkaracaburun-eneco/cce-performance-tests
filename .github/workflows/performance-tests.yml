name: Performance Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  test:
    name: ${{ matrix.test-name }} (${{ matrix.environment }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, test]
        include:
          - test-name: Meter Ingestion Test
            test-file: tests/meter-ingestion.spec.ts
            needs-custom-binary: false
            environment: dev
          - test-name: Meter Ingestion Test
            test-file: tests/meter-ingestion.spec.ts
            needs-custom-binary: false
            environment: test
          - test-name: Health Check Test
            test-file: tests/health-check.spec.ts
            needs-custom-binary: false
            environment: dev
          - test-name: Health Check Test
            test-file: tests/health-check.spec.ts
            needs-custom-binary: false
            environment: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        if: matrix.needs-custom-binary
        uses: actions/setup-go@v5
        with:
          go-version: 'latest'

      - name: Install xk6
        if: matrix.needs-custom-binary
        run: go install go.k6.io/xk6/cmd/xk6@latest

      - name: Build custom k6 binary with Dynatrace extension
        if: matrix.needs-custom-binary
        run: xk6 build --with github.com/Dynatrace/xk6-output-dynatrace

      - name: Setup k6
        if: ${{ !matrix.needs-custom-binary }}
        uses: grafana/setup-k6-action@v1

      - name: Run test
        if: ${{ !matrix.needs-custom-binary }}
        env:
          ENVIRONMENT: ${{ matrix.environment }}
        uses: grafana/run-k6-action@v1
        with:
          path: ${{ matrix.test-file }}
          flags: --compatibility-mode experimental_enhanced
          inspect-flags: --compatibility-mode experimental_enhanced

      - name: Run dynatrace test
        if: matrix.needs-custom-binary
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          K6_DYNATRACE_URL: ${{ secrets.K6_DYNATRACE_URL }}
          K6_DYNATRACE_APITOKEN: ${{ secrets.K6_DYNATRACE_APITOKEN }}
          K6_DYNATRACE_FLUSH_PERIOD: ${{ secrets.K6_DYNATRACE_FLUSH_PERIOD }}
        run: ./k6 run --env ENVIRONMENT=${{ matrix.environment }} ${{ matrix.test-file }} ${{ matrix.output-flag }}
        continue-on-error: true

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ Passed"
            COLOR="good"
          else
            STATUS="❌ Failed"
            COLOR="danger"
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "Performance Test Results",
                "fields": [
                  {
                    "title": "Test",
                    "value": "${{ matrix.test-name }}",
                    "short": true
                  },
                  {
                    "title": "Environment",
                    "value": "${{ matrix.environment }}",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "$STATUS",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "ts": $(date +%s)
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            $SLACK_WEBHOOK_URL